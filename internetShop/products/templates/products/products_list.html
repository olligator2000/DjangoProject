{% extends 'products/base.html' %}

{% load static %}

{% block css %}
<link rel="stylesheet" href="/static/css/products_list.css">
<link rel="stylesheet" href="/static/css/index.css">
{% endblock %}

{% block content %}
<nav class="custom-breadcrumb">
    <a href="{% url 'index' %}" class="custom-breadcrumb-link">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</a> ‚Üí
    <a href="{% url 'products:category_products' category.id %}" class="custom-breadcrumb-link">{{ category.name }}</a> ‚Üí
    <span class="custom-breadcrumb-current">{{ product.name }}</span>
</nav>
<div class="custom-product-card">
    <div class="custom-left-column">
      <h1 class="custom-title">{{ product.name }}</h1>
      <div class="custom-description-title">–û–ø–∏—Å–∞–Ω–∏–µ</div>
      <div class="custom-details">
        <p><strong>–°–æ—Å—Ç–∞–≤:</strong> {{ product.composition }}</p>
        <p><strong>–°—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:</strong>{{ product.manufacturer_country }}</p>
        <p><strong>–ò–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å:</strong>{{ product.manufacturer }}</p>
        <p><strong>–ë—Ä–µ–Ω–¥:</strong>{{ product.brand }}</p>
        <p><strong>–¢–∏–ø —É–ø–∞–∫–æ–≤–∫–∏:</strong>{{ product.packing_type }}</p>
        <p><strong>–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞:</strong>{{ product.material_type }}</p>
        <p><strong>–†–∞–∑–º–µ—Ä (–íx–®x–ì), —Å–º:</strong>{{ product.size }}</p>
        <p><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong>{{ product.recommendations }}</p>
        <p><strong>–£—Å–ª–æ–≤–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è:</strong>{{ product.storage_conditions }}</p>
        <p><strong>–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å:</strong>{{ product.kilocalories }}–ö–∫–∞–ª / {{ product.kilojoule }}–ö–î–∂</p>
        <p><strong>–ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å:</strong> –ë–µ–ª–∫–∏ {{ product.proteins }} –≥, –ñ–∏—Ä—ã {{ product.fats }} –≥, –£–≥–ª–µ–≤–æ–¥—ã
            {{ product.carbs }} –≥</p>
      </div>
    </div>

    <div class="custom-right-column">
      <img class="custom-product-image" src="/media/{{ product.image }}" alt="{{ product.name }}">
      <div class="custom-rating">
        –†–µ–π—Ç–∏–Ω–≥: <span id="custom-rating-value">4.7</span>
        <div class="custom-rating-stars" data-rating="4.7">
          <span class="custom-heart" data-value="1">‚ô•</span>
          <span class="custom-heart" data-value="2">‚ô•</span>
          <span class="custom-heart" data-value="3">‚ô•</span>
          <span class="custom-heart" data-value="4">‚ô•</span>
          <span class="custom-heart" data-value="5">‚ô•</span>
        </div>
      </div>
      <div class="custom-stock">–ù–∞–ª–∏—á–∏–µ: <strong>{{ product.quantity }} —à—Ç.</strong></div>
      <div class="custom-price-section">
        <div class="custom-price">{{ product.price|stringformat:"d" }}</div>
        <div class="custom-quantity-control">
          <button>-</button>
          <input type="text" value="1">
          <button>+</button>
        </div>
        <button class="custom-add-to-cart">üõí <span>–í –∫–æ—Ä–∑–∏–Ω—É</span></button>
      </div>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É -->
<div id="cart-container">
    {% include 'products/basket.html' %}
</div>

{% endblock %}

{% block footer %}
<!--pass-->
{% endblock %}

{% block scripts %}
<script src="/static/js/products_list.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', initCart);

    function initCart() {
        const isAuthenticated = {{ request.user.is_authenticated|lower }};
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

        if (!isAuthenticated) {
            document.querySelectorAll('.add-to-cart-btn, .quantity-btn, .clear-cart-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    alert('–î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω–æ–π –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                    window.location.href = "{% url 'users:login' %}?next={{ request.path }}";
                });
            });
            return;
        }

        if (!csrfToken) {
            console.error('CSRF token not found');
            alert('–û—à–∏–±–∫–∞: CSRF-—Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            return;
        }

        setupHandlers();
    }

    function setupHandlers() {
        document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', () => addToCart(btn.dataset.productId));
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('quantity-btn')) {
                e.preventDefault();
                const { basketId, action } = e.target.dataset;
                if (!basketId || !action) {
                    console.error('Missing basket ID or action');
                    return;
                }
                updateCart(basketId, action);
            } else if (e.target.classList.contains('clear-cart-btn')) {
                e.preventDefault();
                if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∫–æ—Ä–∑–∏–Ω—É?')) clearCart();
            }
        });
    }

    async function addToCart(productId) {
        try {
            const response = await fetch(`/products/add_to_cart_ajax/${productId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRFToken(), 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                const data = await response.json();
                if (data.message === '–¢–æ–≤–∞—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ') {
                    alert('–¢–æ–≤–∞—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ');
                } else {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return;
            }

            const data = await response.json();

            if (data.status === 'success') {
                document.getElementById('cart-container').innerHTML = data.cart_html;
                updateCartBadge(data.total_items);
                const headerTotalElement = document.getElementById('header-total-sum');
                if (headerTotalElement) {
                    headerTotalElement.textContent = data.total_sum;
                    document.getElementById('header-cart-total').innerHTML = `${data.total_sum} ‚ÇΩ`;
                }
            } else {
                alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É');
            }
        } catch (error) {
            console.error('Add to cart failed:', error);
            alert(error.message !== 'HTTP error! Status: 400' ? `–û—à–∏–±–∫–∞: ${error.message}` : '–¢–æ–≤–∞—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ');
        }
    }

    async function updateCart(basketId, action) {
        const cartItem = document.querySelector(`.cart-item[data-basket-id="${basketId}"]`);
        if (!cartItem) {
            console.error('Cart item not found');
            return;
        }

        const quantityElement = cartItem.querySelector('.quantity-value');
        const sumElement = cartItem.querySelector('.item-details');
        const totalElement = document.querySelector('.total-price');
        const headerTotalElement = document.getElementById('header-total-sum');

        const originalQuantity = quantityElement.textContent;
        const originalSum = sumElement.textContent;

        try {
            const response = await fetch(`/products/update_basket_ajax/${basketId}/${action}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRFToken(), 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                const data = await response.json();
                if (response.status === 400 && data.message && data.message.startsWith('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ. –î–æ—Å—Ç—É–ø–Ω–æ: ')) {
                    const availableQuantity = data.message.split(' ').pop();
                    alert(`–ù–∞ —Å–∫–ª–∞–¥–µ –≤—Å–µ–≥–æ ${availableQuantity} —à—Ç—É–∫`);
                } else {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                quantityElement.textContent = originalQuantity;
                sumElement.textContent = originalSum;
                return;
            }

            const data = await response.json();

            if (data.status === 'success') {
                quantityElement.textContent = data.quantity;
                sumElement.textContent = `${data.sum} ‚ÇΩ`;
                if (totalElement) totalElement.textContent = `${data.total_sum} ‚ÇΩ`;
                if (headerTotalElement) headerTotalElement.textContent = data.total_sum;
            } else if (data.status === 'removed') {
                cartItem.style.transition = 'opacity 0.3s';
                cartItem.style.opacity = '0';
                setTimeout(() => cartItem.remove(), 300);
                if (totalElement) totalElement.textContent = `${data.total_sum} ‚ÇΩ`;
                if (headerTotalElement) headerTotalElement.textContent = data.total_sum;
                if (data.total_sum === 0) {
                    document.querySelector('.cart-items-container').innerHTML = '<div class="basket-pusto">–í –∫–æ—Ä–∑–∏–Ω–µ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</div>';
                    document.getElementById('header-cart-total').innerHTML = '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞';
                }
            } else {
                quantityElement.textContent = originalQuantity;
                sumElement.textContent = originalSum;
                alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã');
            }
        } catch (error) {
            console.error('Update cart failed:', error);
            quantityElement.textContent = originalQuantity;
            sumElement.textContent = originalSum;
            alert(`–û—à–∏–±–∫–∞: ${error.message}`);
        }
    }

    async function clearCart() {
        try {
            const response = await fetch('/products/clear_basket_ajax/', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRFToken(), 'Content-Type': 'application/json' }
            });

            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const data = await response.json();

            if (data.status === 'success' || data.status === 'empty') {
                document.getElementById('cart-container').innerHTML = data.cart_html || renderEmptyCart();
                updateCartBadge(0);
                document.getElementById('header-cart-total').innerHTML = '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞';
            } else {
                alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–æ—Ä–∑–∏–Ω—ã');
            }
        } catch (error) {
            console.error('Clear cart failed:', error);
            alert(`–û—à–∏–±–∫–∞: ${error.message}`);
        }
    }

    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    }

    function updateCartBadge(count) {
        const badge = document.querySelector('.cart-badge');
        if (badge) {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'block' : 'none';
        }
    }

    function renderEmptyCart() {
        return `
            <div class="cart-sidebar">
                <div class="cart-header">
                    <h2 class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</h2>
                </div>
                <div class="basket-pusto">–í –∫–æ—Ä–∑–∏–Ω–µ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</div>
            </div>
        `;
    }
</script>

{% endblock %}
